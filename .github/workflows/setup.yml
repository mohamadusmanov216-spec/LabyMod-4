name: Setup LabyMod 4 Project Structure

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  setup-project:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Create project structure
      run: |
        echo "=== Creating LabyMod 4 project structure ==="
        
        # Создаем папки
        mkdir -p src/main/java/com/axmed555/labyvisuals
        mkdir -p src/main/resources
        
        # Перемещаем Java файлы
        echo "=== Moving Java files ==="
        [ -f "LabyVisualsAddon.java" ] && mv LabyVisualsAddon.java src/main/java/com/axmed555/labyvisuals/ && echo "Moved LabyVisualsAddon.java"
        [ -f "VisualEffects.java" ] && mv VisualEffects.java src/main/java/com/axmed555/labyvisuals/ && echo "Moved VisualEffects.java"
        [ -f "KeyHandler.java" ] && mv KeyHandler.java src/main/java/com/axmed555/labyvisuals/ && echo "Moved KeyHandler.java"
        [ -f "Config.java" ] && mv Config.java src/main/java/com/axmed555/labyvisuals/ && echo "Moved Config.java"
        
    - name: Create build.gradle.kts
      run: |
        echo "=== Creating build.gradle.kts ==="
        cat << 'EOF' > build.gradle.kts
plugins {
    id("java")
    id("net.labymod.addon") version "0.2.9"
}

group = "com.axmed555"
version = "1.0.0"

labymod {
    addonInfo {
        namespace = "labyvisuals"
        displayName = "LabyVisuals"
        author = "axmed555"
        description = "Visual effects addon for LabyMod 4"
        minecraftVersion = "1.20.1"
    }
    productionRelease()
}

repositories {
    mavenCentral()
}
EOF

    - name: Create settings.gradle.kts
      run: |
        echo "=== Creating settings.gradle.kts ==="
        cat << 'EOF' > settings.gradle.kts
pluginManagement {
    repositories {
        maven("https://repo.labymod.net/releases/") {
            name = "LabyMod"
        }
        gradlePluginPortal()
        mavenCentral()
    }
}

rootProject.name = "labyvisuals-addon"
EOF

    - name: Create addon.json
      run: |
        echo "=== Creating addon.json ==="
        mkdir -p src/main/resources
        cat << 'EOF' > src/main/resources/addon.json
{
  "schema": 1,
  "name": "LabyVisuals",
  "version": "1.0.0",
  "author": "axmed555",
  "description": "Visual effects addon for LabyMod 4",
  "main": "com.axmed555.labyvisuals.LabyVisualsAddon",
  "minecraft": "1.20.1"
}
EOF

    - name: Build project
      run: gradle clean build --no-daemon --stacktrace
        
    - name: Upload built JAR
      uses: actions/upload-artifact@v4
      with:
        name: labyvisuals-addon
        path: build/libs/*.jar
        retention-days: 30
        
    - name: Show structure
      run: |
        echo "=== Final structure ==="
        find . -name "*.java" -o -name "*.kts" -o -name "*.json" | sort
